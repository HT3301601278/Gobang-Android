# 游戏对战

## RESTful API 接口

### 1. 获取对局历史记录

- **请求方式**: GET
- **接口地址**: `/games/history`
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **请求参数**:

| 参数名    | 类型   | 必填 | 说明                            |
| --------- | ------ | ---- | ------------------------------- |
| page      | number | 否   | 页码，默认为1                   |
| limit     | number | 否   | 每页记录数，默认为20            |
| result    | string | 否   | 筛选结果：win/loss/draw         |
| startDate | string | 否   | 开始日期，格式：YYYY-MM-DD      |
| endDate   | string | 否   | 结束日期，格式：YYYY-MM-DD      |

- **响应**:
  ```json
  {
    "games": [
      {
        "gameId": "对局ID",
        "opponent": {
          "userId": "对手ID",
          "nickname": "对手昵称",
          "avatar": "对手头像URL"
        },
        "result": "win/loss/draw",
        "boardSize": 15,
        "duration": "对局时长（秒）",
        "moves": "总步数",
        "createdAt": "创建时间"
      }
    ],
    "pagination": {
      "total": "总记录数",
      "page": "当前页码",
      "totalPages": "总页数",
      "hasNext": true/false,
      "hasPrev": true/false
    }
  }
  ```

### 2. 获取单局详细信息

- **请求方式**: GET
- **接口地址**: `/games/{gameId}/detail`
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **响应**:
  ```json
  {
    "game": {
      "gameId": "对局ID",
      "players": {
        "black": {
          "userId": "用户ID",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        },
        "white": {
          "userId": "用户ID",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        }
      },
      "boardSize": 15,
      "moves": [
        {
          "step": "步数",
          "position": {
            "x": "x坐标",
            "y": "y坐标"
          },
          "timestamp": "时间戳"
        }
      ],
      "undoHistory": "悔棋历史",
      "result": {
        "winner": "获胜者ID",
        "reason": "five_in_row/draw/resign/timeout"
      },
      "duration": "对局时长（秒）",
      "createdAt": "创建时间",
      "finishedAt": "结束时间"
    }
  }
  ```

### 3. 获取棋谱复盘数据

- **请求方式**: GET
- **接口地址**: `/games/{gameId}/replay`
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **响应**:
  ```json
  {
    "replay": {
      "players": {
        "black": {
          "userId": "用户ID",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        },
        "white": {
          "userId": "用户ID",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        }
      },
      "moves": [
        {
          "step": "步数",
          "position": {
            "x": "x坐标",
            "y": "y坐标"
          },
          "timestamp": "时间戳"
        }
      ],
      "result": {
        "winner": "获胜者ID",
        "reason": "five_in_row/draw/resign/timeout"
      },
      "boardSize": 15
    }
  }
  ```

### 4. 获取对局聊天历史记录

- **请求方式**: GET
- **接口地址**: `/games/{gameId}/chat`
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **请求参数**:

| 参数名 | 类型   | 必填 | 说明                 |
| ------ | ------ | ---- | -------------------- |
| page   | number | 否   | 页码，默认为1        |
| limit  | number | 否   | 每页记录数，默认为50 |

- **响应**:
  ```json
  {
    "messages": [
      {
        "messageId": "消息ID",
        "senderId": "发送者ID",
        "senderNickname": "发送者昵称",
        "type": "text/emoji/quick_phrase",
        "content": "消息内容",
        "timestamp": "发送时间"
      }
    ],
    "pagination": {
      "total": "总记录数",
      "page": "当前页码",
      "hasNext": true/false
    }
  }
  ```

## Socket.io 事件

### 客户端发送事件

#### 1. 开始游戏
- **事件名称**: `game:start`
- **参数**:
  ```json
  {
    "roomId": "房间ID",
    "gameSettings": {
      "boardSize": 15,
      "timeLimit": 30,
      "totalTimeLimit": 600,
      "allowUndo": true,
      "maxUndoCount": 3
    }
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "游戏已成功创建，对局开始"
  }
  ```

#### 2. 获取游戏状态
- **事件名称**: `game:get_state`
- **参数**:
  ```json
  {
    "gameId": "游戏ID"
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "gameState": {
      "gameId": "游戏ID",
      "roomId": "房间ID",
      "players": {
        "black": {
          "userId": "用户ID",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        },
        "white": {
          "userId": "用户ID",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        }
      },
      "boardState": "二维数组表示的棋盘状态",
      "currentStep": "当前步数",
      "currentPlayer": "当前玩家ID",
      "isMyTurn": true/false,
      "playerRole": "black/white",
      "gameSettings": {
        "boardSize": 15,
        "timeLimit": 30,
        "totalTimeLimit": 600,
        "allowUndo": true,
        "maxUndoCount": 3
      },
      "lastMoveTime": "最后一步的时间",
      "lastMoveRemainingTime": "最后一步的剩余时间",
      "moves": "所有步骤的记录",
      "undoHistory": "悔棋历史",
      "status": "游戏状态",
      "result": "游戏结果"
    }
  }
  ```

#### 3. 落子
- **事件名称**: `game:move`
- **参数**:
  ```json
  {
    "gameId": "游戏ID",
    "position": {
      "x": 7,
      "y": 7
    }
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "落子成功"
  }
  ```

#### 4. 悔棋请求
- **事件名称**: `game:undo_request`
- **参数**:
  ```json
  {
    "gameId": "游戏ID"
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "悔棋请求已发送"
  }
  ```

#### 5. 悔棋响应
- **事件名称**: `game:undo_response`
- **参数**:
  ```json
  {
    "gameId": "游戏ID",
    "accept": true/false
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "悔棋成功/已拒绝悔棋"
  }
  ```

#### 6. 和棋请求
- **事件名称**: `game:draw_request`
- **参数**:
  ```json
  {
    "gameId": "游戏ID"
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "和棋请求已发送"
  }
  ```

#### 7. 和棋响应
- **事件名称**: `game:draw_response`
- **参数**:
  ```json
  {
    "gameId": "游戏ID",
    "accept": true/false
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "和棋成功/已拒绝和棋"
  }
  ```

#### 8. 认输
- **事件名称**: `game:resign`
- **参数**:
  ```json
  {
    "gameId": "游戏ID"
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "认输成功"
  }
  ```

#### 9. 发送游戏内聊天消息
- **事件名称**: `chat:send_message`
- **参数**:
  ```json
  {
    "gameId": "游戏ID",
    "type": "text",
    "content": "聊天内容"
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "消息发送成功"
  }
  ```

#### 10. 发送表情
- **事件名称**: `chat:send_emoji`
- **参数**:
  ```json
  {
    "gameId": "游戏ID",
    "emojiId": 1
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "表情发送成功"
  }
  ```

#### 11. 发送快捷短语
- **事件名称**: `chat:send_quick_phrase`
- **参数**:
  ```json
  {
    "gameId": "游戏ID",
    "phraseId": "短语ID",
    "isSystem": true/false
  }
  ```
- **回调响应**:
  ```json
  {
    "success": true,
    "message": "快捷短语发送成功"
  }
  ```

### 客户端接收事件

#### 1. 游戏开始
- **事件名称**: `game:started`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "players": {
      "black": {
        "userId": "用户ID",
        "nickname": "用户昵称",
        "avatar": "头像URL"
      },
      "white": {
        "userId": "用户ID",
        "nickname": "用户昵称",
        "avatar": "头像URL"
      }
    },
    "currentPlayer": "当前玩家ID",
    "boardSize": 15,
    "board": "初始空棋盘",
    "gameSettings": {
      "boardSize": 15,
      "timeLimit": 30,
      "totalTimeLimit": 600,
      "allowUndo": true,
      "maxUndoCount": 3
    }
  }
  ```

#### 2. 重连状态
- **事件名称**: `game:reconnect_state`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "roomId": "房间ID",
    "players": {
      "black": {
        "userId": "用户ID",
        "nickname": "用户昵称",
        "avatar": "头像URL"
      },
      "white": {
        "userId": "用户ID",
        "nickname": "用户昵称",
        "avatar": "头像URL"
      }
    },
    "boardState": "二维数组表示的棋盘状态",
    "currentStep": "当前步数",
    "currentPlayer": "当前玩家ID",
    "isMyTurn": true/false,
    "playerRole": "black/white",
    "gameSettings": "游戏设置",
    "lastMoveTime": "最后一步的时间",
    "lastMoveRemainingTime": "最后一步的剩余时间",
    "moves": "所有步骤的记录",
    "undoHistory": "悔棋历史"
  }
  ```

#### 3. 玩家重连
- **事件名称**: `game:player_reconnected`
- **数据格式**:
  ```json
  {
    "userId": "用户ID",
    "playerRole": "black/white",
    "message": "玩家重新连接消息"
  }
  ```

#### 4. 落子完成
- **事件名称**: `game:move_made`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "move": {
      "step": "步数",
      "playerId": "玩家ID",
      "position": {
        "x": "x坐标",
        "y": "y坐标"
      },
      "remainingTime": "剩余时间",
      "timestamp": "时间戳"
    },
    "nextPlayer": "下一个玩家ID",
    "boardState": "更新后的棋盘状态",
    "gameStatus": "游戏状态"
  }
  ```

#### 5. 游戏结束
- **事件名称**: `game:ended`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "result": {
      "winner": "获胜者ID",
      "reason": "five_in_row/draw/resign/timeout",
      "endTime": "结束时间"
    },
    "finalBoard": "最终棋盘状态"
  }
  ```

#### 6. 收到悔棋请求
- **事件名称**: `game:undo_requested`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "requester": {
      "userId": "请求者ID",
      "nickname": "请求者昵称"
    }
  }
  ```

#### 7. 悔棋被拒绝
- **事件名称**: `game:undo_rejected`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "message": "对手拒绝了悔棋请求"
  }
  ```

#### 8. 悔棋成功
- **事件名称**: `game:undo_success`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "newBoardState": "新的棋盘状态",
    "currentPlayer": "当前玩家ID",
    "removedMoves": "被移除的步骤",
    "message": "对方已同意悔棋请求"
  }
  ```

#### 9. 收到和棋请求
- **事件名称**: `game:draw_requested`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "requester": {
      "userId": "请求者ID",
      "nickname": "请求者昵称"
    }
  }
  ```

#### 10. 和棋被拒绝
- **事件名称**: `game:draw_rejected`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "message": "对手拒绝了和棋请求"
  }
  ```

#### 11. 和棋成功
- **事件名称**: `game:draw_success`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "message": "双方同意和棋"
  }
  ```

#### 12. 对手认输
- **事件名称**: `game:opponent_resigned`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "resignerId": "认输者ID",
    "resignerNickname": "认输者昵称",
    "message": "对手已认输，您获胜了"
  }
  ```

#### 13. 接收聊天消息
- **事件名称**: `chat:message_received`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "message": {
      "messageId": "消息ID",
      "senderId": "发送者ID",
      "senderNickname": "发送者昵称",
      "type": "text/quick_phrase",
      "content": "消息内容",
      "timestamp": "发送时间"
    }
  }
  ```

#### 14. 接收表情
- **事件名称**: `chat:emoji_received`
- **数据格式**:
  ```json
  {
    "gameId": "游戏ID",
    "senderId": "发送者ID",
    "senderNickname": "发送者昵称",
    "emojiId": "表情ID",
    "emojiUrl": "表情URL",
    "emojiName": "表情名称",
    "timestamp": "发送时间"
  }
  ```
