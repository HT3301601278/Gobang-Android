# 五子棋Flutter应用设计大纲

## 项目目录结构

```
gobang/
├── assets/
│   ├── images/
│   │   ├── logo.png
│   │   ├── avatars/ # 系统头像
│   │   ├── emojis/ # 表情包
│   │   └── backgrounds/ # 背景图片
│   └── sounds/ # 游戏音效
├── lib/
│   ├── main.dart # 应用入口
│   ├── app.dart # 应用配置和路由
│   ├── config/
│   │   ├── app_config.dart # 应用配置
│   │   ├── api_endpoints.dart # API端点
│   │   └── socket_events.dart # Socket事件常量
│   ├── models/ # 数据模型
│   │   ├── user.dart # 用户模型
│   │   ├── friend.dart # 好友模型
│   │   ├── room.dart # 房间模型
│   │   ├── game.dart # 游戏模型
│   │   ├── message.dart # 聊天消息模型
│   │   ├── game_settings.dart # 游戏设置模型
│   │   ├── avatar.dart # 头像模型
│   │   ├── emoji.dart # 表情模型
│   │   ├── quick_phrase.dart # 快捷短语模型
│   │   ├── game_move.dart # 游戏步骤模型
│   │   ├── game_result.dart # 游戏结果模型
│   │   └── voice_participant.dart # 语音参与者模型
│   ├── services/ # 服务
│   │   ├── api/ # API服务
│   │   │   ├── api_client.dart # 基础HTTP客户端
│   │   │   ├── auth_service.dart # 认证服务
│   │   │   ├── user_service.dart # 用户服务
│   │   │   ├── friend_service.dart # 好友服务
│   │   │   ├── game_service.dart # 游戏服务
│   │   │   ├── avatar_service.dart # 头像服务
│   │   │   ├── emoji_service.dart # 表情服务
│   │   │   └── quick_phrase_service.dart # 快捷短语服务
│   │   ├── socket/ # Socket服务
│   │   │   ├── socket_client.dart # Socket.IO客户端
│   │   │   ├── room_socket.dart # 房间Socket事件处理
│   │   │   ├── game_socket.dart # 游戏Socket事件处理
│   │   │   ├── friend_socket.dart # 好友Socket事件处理
│   │   │   ├── voice_socket.dart # 语音Socket事件处理
│   │   │   └── chat_socket.dart # 聊天Socket事件处理
│   │   ├── voice/ # 语音服务
│   │   │   ├── voice_service.dart # 语音服务实现
│   │   │   └── audio_processor.dart # 音频处理
│   │   ├── storage_service.dart # 本地存储服务
│   │   ├── notification_service.dart # 通知服务
│   │   └── reconnection_service.dart # 断线重连服务
│   ├── providers/ # 状态管理
│   │   ├── auth_provider.dart # 认证状态
│   │   ├── user_provider.dart # 用户信息状态
│   │   ├── friend_provider.dart # 好友状态
│   │   ├── room_provider.dart # 房间状态
│   │   ├── game_provider.dart # 游戏状态
│   │   ├── voice_provider.dart # 语音状态
│   │   ├── chat_provider.dart # 聊天状态
│   │   └── connection_provider.dart # 连接状态
│   ├── screens/ # 页面
│   │   ├── splash_screen.dart # 启动页
│   │   ├── auth/ # 认证相关页面
│   │   │   ├── login_screen.dart # 登录页
│   │   │   ├── register_screen.dart # 注册页
│   │   │   ├── forgot_password_screen.dart # 忘记密码页
│   │   │   └── reset_password_screen.dart # 重置密码页
│   │   ├── home/ # 主页
│   │   │   ├── home_screen.dart # 主页
│   │   │   ├── profile_tab.dart # 个人资料页
│   │   │   ├── friends_tab.dart # 好友列表页
│   │   │   └── rooms_tab.dart # 房间列表页
│   │   ├── profile/ # 个人资料相关
│   │   │   ├── edit_profile_screen.dart # 编辑资料
│   │   │   ├── avatar_selection_screen.dart # 头像选择
│   │   │   ├── stats_screen.dart # 战绩统计
│   │   │   ├── settings_screen.dart # 设置页面
│   │   │   ├── change_password_screen.dart # 修改密码页
│   │   │   └── quick_phrases_screen.dart # 快捷短语管理
│   │   ├── friend/ # 好友相关
│   │   │   ├── friend_detail_screen.dart # 好友详情
│   │   │   ├── friend_requests_screen.dart # 好友请求
│   │   │   └── search_users_screen.dart # 搜索用户
│   │   ├── room/ # 房间相关
│   │   │   ├── create_room_screen.dart # 创建房间
│   │   │   ├── room_detail_screen.dart # 房间详情
│   │   │   ├── invite_friends_screen.dart # 邀请好友
│   │   │   └── room_waiting_screen.dart # 房间等待页
│   │   ├── game/ # 游戏相关
│   │   │   ├── game_screen.dart # 游戏页面
│   │   │   ├── game_result_screen.dart # 游戏结果
│   │   │   ├── game_history_screen.dart # 历史记录
│   │   │   └── game_replay_screen.dart # 棋谱复盘
│   │   └── chat/ # 聊天相关
│   │       ├── chat_screen.dart # 聊天页面
│   │       └── emoji_selection_screen.dart # 表情选择页
│   ├── widgets/ # 组件
│   │   ├── common/ # 通用组件
│   │   │   ├── app_bar.dart # 自定义应用栏
│   │   │   ├── loading_indicator.dart # 加载指示器
│   │   │   ├── avatar_widget.dart # 头像组件
│   │   │   ├── error_dialog.dart # 错误对话框
│   │   │   ├── confirmation_dialog.dart # 确认对话框
│   │   │   ├── connection_status_widget.dart # 连接状态组件
│   │   │   └── notification_widget.dart # 通知组件
│   │   ├── auth/ # 认证相关组件
│   │   │   ├── login_form.dart # 登录表单
│   │   │   ├── register_form.dart # 注册表单
│   │   │   └── password_reset_form.dart # 密码重置表单
│   │   ├── friend/ # 好友相关组件
│   │   │   ├── friend_list_item.dart # 好友列表项
│   │   │   ├── friend_request_item.dart # 好友请求项
│   │   │   └── friend_status_indicator.dart # 好友状态指示器
│   │   ├── room/ # 房间相关组件
│   │   │   ├── room_list_item.dart # 房间列表项
│   │   │   ├── room_settings_form.dart # 房间设置表单
│   │   │   ├── room_invitation_dialog.dart # 房间邀请对话框
│   │   │   └── player_list_widget.dart # 玩家列表组件
│   │   ├── game/ # 游戏相关组件
│   │   │   ├── board_widget.dart # 棋盘组件
│   │   │   ├── piece_widget.dart # 棋子组件
│   │   │   ├── game_control_panel.dart # 游戏控制面板
│   │   │   ├── timer_widget.dart # 计时器组件
│   │   │   ├── move_history_widget.dart # 走棋历史组件
│   │   │   ├── game_request_dialog.dart # 游戏请求对话框(悔棋/和棋)
│   │   │   └── game_stats_widget.dart # 游戏统计组件
│   │   ├── chat/ # 聊天相关组件
│   │   │   ├── message_list.dart # 消息列表
│   │   │   ├── message_input.dart # 消息输入框
│   │   │   ├── emoji_panel.dart # 表情面板
│   │   │   ├── quick_phrase_panel.dart # 快捷短语面板
│   │   │   └── message_bubble.dart # 消息气泡组件
│   │   └── voice/ # 语音相关组件
│   │       ├── voice_control_panel.dart # 语音控制面板
│   │       ├── participant_list.dart # 参与者列表
│   │       └── voice_settings_panel.dart # 语音设置面板
│   ├── utils/ # 工具类
│   │   ├── validators.dart # 表单验证
│   │   ├── date_formatter.dart # 日期格式化
│   │   ├── token_manager.dart # Token管理
│   │   ├── game_logic.dart # 游戏逻辑工具
│   │   ├── audio_utils.dart # 音频处理工具
│   │   ├── network_utils.dart # 网络工具
│   │   ├── file_utils.dart # 文件处理工具
│   │   └── constants.dart # 常量定义
│   ├── theme/ # 主题
│   │   ├── app_theme.dart # 应用主题
│   │   ├── app_colors.dart # 颜色定义
│   │   └── text_styles.dart # 文字样式
│   └── game/ # 游戏核心逻辑
│       ├── board.dart # 棋盘逻辑
│       ├── move.dart # 走棋逻辑
│       ├── game_controller.dart # 游戏控制器
│       ├── win_checker.dart # 胜负判断
│       └── game_timer.dart # 游戏计时器
└── pubspec.yaml # 项目依赖
```

## 核心功能模块说明

### 1. 用户认证模块
- **注册功能**: 用户名、邮箱、密码、昵称注册
- **登录功能**: 用户名/密码登录，返回JWT令牌和用户信息
- **密码管理**: 忘记密码邮箱验证码重置、登录后修改密码
- **令牌管理**: JWT令牌本地存储、自动刷新、过期处理
- **登出功能**: 安全登出，清理本地存储

### 2. 用户资料模块
- **个人资料**: 获取和更新用户昵称、头像等信息
- **头像系统**: 支持系统头像库、自定义头像上传
- **战绩统计**: 总对局数、胜负平局数、胜率计算
- **快捷短语**: 系统预设和用户自定义快捷短语管理
- **表情系统**: 系统表情包支持

### 3. 好友系统模块
- **好友列表**: 展示已添加好友，显示在线状态
- **好友请求**: 发送、接收、接受、拒绝好友请求
- **用户搜索**: 通过关键词搜索用户并添加好友
- **好友管理**: 删除好友、查看好友详情和战绩
- **实时状态**: Socket.IO实时更新好友在线状态

### 4. 房间管理模块
- **房间创建**: 房主创建房间并设置游戏参数
- **房间加入**: 通过房间ID加入房间
- **邀请系统**: 房主邀请好友加入房间
- **权限管理**: 房主权限控制，客人权限限制
- **断线处理**: 玩家断线重连机制，房主变更逻辑
- **房间状态**: 实时同步房间内玩家状态

### 5. 游戏对战模块
- **游戏开始**: 房间满员后开始游戏，分配黑白棋
- **棋盘逻辑**: 15x15标准棋盘，五子连珠胜利判断
- **落子系统**: 实时落子同步，合法性验证
- **游戏控制**: 悔棋请求/响应、和棋请求/响应、认输功能
- **计时系统**: 单步计时和总时间限制
- **游戏记录**: 完整棋谱记录、历史对局查询
- **复盘功能**: 棋谱回放、步骤分析

### 6. 聊天模块
- **文字聊天**: 游戏内实时文字消息
- **表情发送**: 系统表情包选择发送
- **快捷短语**: 系统和自定义快捷短语发送
- **聊天历史**: 对局聊天记录保存和查询
- **消息同步**: Socket.IO实时消息推送

### 7. 语音聊天模块
- **语音通话**: 房间内语音实时通信
- **麦克风控制**: 静音/取消静音功能
- **参与者管理**: 显示语音参与者列表和状态
- **语音设置**: 房主控制语音功能开关
- **音频处理**: 音频数据编码、传输、解码

### 8. 数据同步与通信
- **Socket.IO集成**: 实时双向通信
- **事件处理**: 房间、游戏、好友、语音事件处理
- **断线重连**: 自动重连机制，状态恢复
- **错误处理**: 网络异常处理，用户友好提示
- **消息队列**: 离线消息处理，重要事件重试

## 状态管理设计

采用Provider模式管理状态，主要包括：

### 1. AuthProvider (认证状态管理)
- 用户登录状态
- JWT令牌管理
- 自动登录逻辑
- 登出处理

### 2. UserProvider (用户信息状态管理)
- 当前用户资料信息
- 头像和昵称更新
- 战绩统计数据
- 快捷短语管理

### 3. FriendProvider (好友状态管理)
- 好友列表数据
- 好友请求列表
- 好友在线状态
- 好友搜索结果

### 4. RoomProvider (房间状态管理)
- 当前房间信息
- 房间内玩家列表
- 房间设置参数
- 邀请状态管理

### 5. GameProvider (游戏状态管理)
- 棋盘状态数据
- 当前游戏信息
- 游戏计时器
- 走棋历史记录
- 游戏结果

### 6. ChatProvider (聊天状态管理)
- 聊天消息列表
- 表情和快捷短语
- 消息发送状态
- 聊天历史

### 7. VoiceProvider (语音状态管理)
- 语音通话状态
- 参与者列表
- 麦克风状态
- 语音设置

### 8. ConnectionProvider (连接状态管理)
- Socket连接状态
- 网络连接状态
- 重连逻辑
- 离线模式处理

## API服务设计

### 1. RESTful API服务
- **AuthService**: 处理用户认证相关API调用
- **UserService**: 处理用户资料相关API调用
- **FriendService**: 处理好友系统相关API调用
- **GameService**: 处理游戏历史和统计API调用
- **AvatarService**: 处理头像上传和系统头像API调用
- **EmojiService**: 处理表情包相关API调用
- **QuickPhraseService**: 处理快捷短语相关API调用

### 2. Socket.IO事件处理
- **RoomSocket**: 房间相关事件处理
- **GameSocket**: 游戏对战相关事件处理
- **FriendSocket**: 好友系统相关事件处理
- **VoiceSocket**: 语音聊天相关事件处理
- **ChatSocket**: 聊天消息相关事件处理

## 关键技术实现

### 1. 断线重连机制
- Socket.IO自动重连配置
- 重连后状态恢复
- 离线消息处理
- 用户友好的连接状态提示

### 2. 游戏状态同步
- 实时棋盘状态同步
- 游戏计时器同步
- 玩家操作权限控制
- 游戏结果一致性保证

### 3. 语音通信
- WebRTC音频通信
- 音频数据压缩传输
- 麦克风权限管理
- 音频质量优化

### 4. 本地存储
- 用户认证信息存储
- 游戏设置偏好存储
- 聊天历史缓存
- 离线数据同步